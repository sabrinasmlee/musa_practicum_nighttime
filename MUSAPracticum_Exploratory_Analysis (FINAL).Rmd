---
title: "MUSA Practicum Nighttime Economy: Exploratory Analysis"
author: "Maddy Kornhauser, Brian Rawn, Sabrina Lee"
date: "2/21/2021"
output:
  github_document:
    toc: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
	echo = TRUE,
	message = FALSE,
	warning = FALSE,
	out.height = "\\textheight",  out.width = "\\textwidth"
)
```
# 1. Use Case Development

[TBD]

# 2. The SafeGraph Dataset

[TBD]

# 3. Exploratory Data Analysis

```{r load packages, include=FALSE}
library(tidyverse)
library(tidycensus)
library(sf)
library(lubridate)
library(datetime)
library(viridis)
library(gridExtra)
library(kableExtra)
library(dplyr)
library(ggplot2)
library(gganimate)


qBr <- function(df, variable, rnd) {
  if (missing(rnd)) {
    as.character(quantile(round(df[[variable]],0),
                          c(.01,.2,.4,.6,.8), na.rm=T))
  } else if (rnd == FALSE | rnd == F) {
    as.character(formatC(quantile(df[[variable]]), digits = 3),
                 c(.01,.2,.4,.6,.8), na.rm=T)
  }
}
q5 <- function(variable) {as.factor(ntile(variable, 5))}
palette3 <- viridis_pal()(3)
palette5 <- viridis_pal()(5)
mapTheme <- function(base_size = 12) {
  theme(
    text = element_text( color = "black"),
    plot.title = element_text(size = 14,colour = "black"),
    plot.subtitle=element_text(face="italic"),
    plot.caption=element_text(hjust=0),
    axis.ticks = element_blank(),
    panel.background = element_blank(),axis.title = element_blank(),
    axis.text = element_blank(),
    axis.title.x = element_blank(),
    axis.title.y = element_blank(),
    panel.grid.minor = element_blank(),
    panel.border = element_rect(colour = "black", fill=NA, size=2)
  )
}

plotTheme <- function(base_size = 12) {
  theme(
    text = element_text( color = "black"),
    plot.title = element_text(size = 16,colour = "black"),
    plot.subtitle = element_text(face="italic"),
    plot.caption = element_text(hjust=0),
    axis.ticks = element_blank(),
    panel.background = element_blank(),
    panel.grid.major = element_line("grey80", size = 0.1),
    panel.grid.minor = element_blank(),
    panel.border = element_rect(colour = "black", fill=NA, size=2),
    strip.background = element_rect(fill = "grey80", color = "white"),
    strip.text = element_text(size=12),
    axis.title = element_text(size=12),
    axis.text = element_text(size=10),
    plot.background = element_blank(),
    legend.background = element_blank(),
    legend.title = element_text(colour = "black", face = "italic"),
    legend.text = element_text(colour = "black", face = "italic"),
    strip.text.x = element_text(size = 14)
  )
}


setwd("~/GitHub/musa_practicum_nighttime")
```

```{r load & wrangle data}
dat <- read.csv("./data/moves_2018.csv")
phila <- st_read("./demo/phila.geojson") %>%
  st_transform('ESRI:102728') %>%
  st_as_sf()

dat2 <- dat %>% 
  dplyr::select(safegraph_place_id, 
                date_range_start, 
                date_range_end, 
                raw_visit_counts,
                raw_visitor_counts, 
                visits_by_day, 
                poi_cbg, 
                visitor_home_cbgs, 
                visitor_daytime_cbgs, 
                visitor_work_cbgs, 
                visitor_country_of_origin,
                distance_from_home, 
                median_dwell, 
                bucketed_dwell_times, 
                related_same_day_brand, 
                related_same_month_brand, 
                popularity_by_hour, 
                popularity_by_day, 
                device_type) %>%
  left_join(., phila, by = "safegraph_place_id") %>% 
  st_as_sf()

phl_cbg <- st_read("http://data.phl.opendata.arcgis.com/datasets/2f982bada233478ea0100528227febce_0.geojson") %>%
  st_transform('ESRI:102728') %>%
  mutate(GEOID10 = as.numeric(GEOID10))
phl_zip <- st_read("http://data.phl.opendata.arcgis.com/datasets/b54ec5210cee41c3a884c9086f7af1be_0.geojson") %>%
  st_transform('ESRI:102728') %>%
  mutate(CODE = as.numeric(CODE))
phl_nhoods <- 
  st_read("https://raw.githubusercontent.com/azavea/geo-data/master/Neighborhoods_Philadelphia/Neighborhoods_Philadelphia.geojson") %>%
  st_transform('ESRI:102728') %>% 
  st_as_sf()
phl_corridors <- st_read("http://data.phl.opendata.arcgis.com/datasets/f43e5f92d34e41249e7a11f269792d11_0.geojson") %>%
  st_transform('ESRI:102728')


```

## Philadelphia nightlife establishments

Our first question involve where Philadelhpia nightlife establishments are located across the city. The following maps indicate where in city businesses that contribute to the city's nightlife economy are located. These categories were decided by consulting with the instructors and the Fishtown BID Operations manager. The categories include:

* Bars (Drinking Places)
* Restaurants 
* Hotels (Travel Accomodation)
* Casinos (Gambling Industries)
* Arts Venues (Promotes of Performing Arts)

Figure 3.1 below shows the spatial patterns of the business categories. Bars and restaurants represent the highest number of businesses which are spread across the city. Hotels are mostly clustered in the central district of the city and near the airport in the southwest portion of the city. There are far fewer casinos and arts venues.

```{r establishment locations}
dat2 %>%
  filter(top_category == "Drinking Places (Alcoholic Beverages)" |
           top_category == "Restaurants and Other Eating Places" |
           top_category == "Traveler Accommodation" |
           top_category == "Gambling Industries" |
           top_category == "Promoters of Performing Arts, Sports, and Similar Events" |
           top_category == "Performing Arts Companies") %>%
  ggplot() + 
  geom_sf(data = phl_cbg, fill = "grey80", color = "transparent") +
  geom_sf(color = "red", size = .1) +
  labs(title = "Location of Nightlife Establishments",
       subtitle = "Figure 3.1") +
  facet_wrap(~top_category) +
  mapTheme()
```

To look at the spatial patterns another way, we observe the distribution of bars, restaurants and hotels, our largest business categories, with a fishnet grid. Figure 3.2 below demonstrates the spatial patterns of restaurants.  Though restaurants are well distributed throughout the city, there is a distinct cluster in center city.
```{r unnesting hour dataset}
#Unnesting popularity by hour variable
dat_hour <- 
  dat2 %>% 
  select(safegraph_place_id, 
         top_category, 
         sub_category, 
         popularity_by_hour, 
         poi_cbg) %>% #select variables
  mutate(popularity_by_hour = str_remove_all(popularity_by_hour, pattern = "\\[|\\]")) %>%   unnest(popularity_by_hour) %>% #unnest values
  separate(.,
           popularity_by_hour,
           c("0", "1", "2", "3", "4", "5", "6", 
             "7", "8", "9", "10", "11", "12", 
             "13", "14", "15", "16", "17", "18",
             "19", "20", "21", "22", "23"),
           sep = ",") %>% #separate into columns by hour
  pivot_longer(cols = 4:27,
               names_to = "Hour",
               values_to = "Visitors") %>% #pivot into long format
  mutate(Hour = as.numeric(Hour),
         Visitors = as.numeric(Visitors))

#Creating a fishnet
phillyBoundary <- 
  phl_zip %>%
  select(geometry) %>%
  st_union() %>%
   st_transform('ESRI:102728') %>% 
  st_as_sf() 

fishnet <- 
  st_make_grid(phillyBoundary, cellsize = 2000, square = FALSE) %>%
  .[phillyBoundary] %>% #MK added this line
  st_sf() %>%
  mutate(uniqueID = rownames(.))

#Plot fishnet
ggplot() + 
  geom_sf(data = fishnet, fill = "#440255", color = "black")

#Transform restaurants coordinates (Takes a long time)
dat_restaurants_grid <- 
  dat_hour %>%
  filter(top_category == "Restaurants and Other Eating Places") %>%
  select(geometry) %>%
  na.omit() %>%
  st_as_sf() %>%
  st_transform('ESRI:102728') %>% 
    distinct()

#Merge restaurants with fishnet  
restaurant_net <- 
  dplyr::select(dat_restaurants_grid) %>% 
  mutate(countRestaurant = 1) %>% 
  aggregate(., fishnet, sum) %>%
  mutate(countRestaurant = replace_na(countRestaurant, 0),
         uniqueID = rownames(.),
         cvID = sample(round(nrow(fishnet) / 24), size=nrow(fishnet), replace = TRUE))

#Plot restaurant fishnet
ggplot() +
  geom_sf(data = restaurant_net, aes(fill = countRestaurant)) +
  scale_fill_viridis(trans = "sqrt") +
  labs(title = "Count of Restaurants per Grid Space",
       subtitle = "Figure 3.2") +
  mapTheme()
```

Figure 3.3 plots the same map for bars. This also demonstrates a clustering of bars primarily in the central district.
```{r bars grid}
#Transform bar coordinates (Takes a long time)
dat_bars_grid <- 
  dat_hour %>%
  filter(top_category == "Drinking Places (Alcoholic Beverages)") %>%
  select(geometry) %>%
  #na.omit() %>%
  st_as_sf() %>%
  st_transform('ESRI:102728') %>%
    distinct()

#Merge bars with fishnet
bar_net <-
  dplyr::select(dat_bars_grid) %>%
  mutate(countBar = 1) %>%
  aggregate(., fishnet, sum) %>%
  mutate(countBar = replace_na(countBar, 0),
         uniqueID = rownames(.),
         cvID = sample(round(nrow(fishnet) / 24), size=nrow(fishnet), replace = TRUE))

#Plot bar fishnet
ggplot() +
  geom_sf(data = bar_net, aes(fill = countBar)) +
  scale_fill_viridis(trans = "sqrt") +
  labs(title = "Count of Bars per Grid Space",
       subtitle = "Figure 3.3") +
  mapTheme()
```

Figure 3.4 shows the number of hotels by grid cell. As we could see above, this figure shows the primary cluster is in Center City with the airport near the city's southwest boundary being a secondary cluster.
```{r travel accommodation grid}
#Transform hotel coordinates (Takes a long time)
dat_hotels_grid <- 
  dat_hour %>%
  filter(top_category == "Traveler Accommodation") %>%
  select(geometry) %>%
  #na.omit() %>%
  st_as_sf() %>%
  st_transform('ESRI:102728') %>%
    distinct()

#Merge bars with fishnet
hotels_net <-
  dplyr::select(dat_hotels_grid) %>%
  mutate(countHotel = 1) %>%
  aggregate(., fishnet, sum) %>%
  mutate(countHotel = replace_na(countHotel, 0),
         uniqueID = rownames(.),
         cvID = sample(round(nrow(fishnet) / 24), size=nrow(fishnet), replace = TRUE))

#Plot bar fishnet
ggplot() +
  geom_sf(data = hotels_net, aes(fill = countHotel)) +
  scale_fill_viridis(trans = "sqrt") +
  labs(title = "Count of Hotels per Grid Space",
       subtitle = "Figure 3.4") +
  mapTheme()
```

## Nightlife hours

Next we explore when visitors make trips to nightlife establishments. To do this, we worked with the popularity_by_hour SafeGraph variable, which sums the total number of visitors by hour for each month.

Figure 3.5 shows the average foot traffic by business type over the course of a day. This graphic indicates that though certain business types are considererd part of the nightlife economy, they do not exclusively experience traffic in the evenings.  Restaurants are a good example of this, where the data indicates that the highest levels of traffic occur in the middle of the day. Arts venues, on the other hand, have a clear patterns indicating that they are more popular later in the day.

```{r traffic by nightlife establishment}
dat_hour %>%
  filter(top_category == "Drinking Places (Alcoholic Beverages)" |
           top_category == "Restaurants and Other Eating Places" |
           top_category == "Traveler Accommodation" |
           top_category == "Gambling Industries" |
           top_category == "Promoters of Performing Arts, Sports, and Similar Events" |
           top_category == "Performing Arts Companies") %>%
  group_by(Hour, top_category) %>%
  summarize(Visitors = mean(Visitors)) %>%
  ggplot(., aes(x = Hour, y = Visitors)) + 
  geom_col() +
  labs(title = "Philadelphia Nightlife Organizations, Average Traffic by Hour",
       subtitle = "Figure 3.5") +
  facet_wrap(~top_category, scales = "free") +
  plotTheme()
```


The following animation shows restaurant visitor counts by census block group over the course of the day. We observe the highest amount of traffic in center city in the middle of the day and then a resurgence of traffic elsewhere in the city in the evening. This suggests that people dine at neighborhood establishments close to their home in the evening.
```{r}
dat_restaurants <-
  dat_hour %>%
  filter(top_category == "Restaurants and Other Eating Places") 

dat_restaurant_filter <-
  dat_restaurants %>%
  rename(., GEOID10 = poi_cbg) %>%
  group_by(GEOID10, Hour) %>%
  summarize(Avg_Popularity = mean(Visitors),
            Total_Visits = sum(Visitors)) %>%
  left_join(phl_cbg) %>% 
  st_as_sf() %>%
  mutate(Visits_Per_Area = Total_Visits / Shape__Area * 100)

#Animation of restaurant popularity by hour
restaurant.animation.data <-
    dat_restaurant_filter %>%
    st_sf() %>%
    mutate(Pop_String = case_when(Visits_Per_Area < .4 ~ "5",
                              Visits_Per_Area >= .4 & Visits_Per_Area <.8 ~ "4",
                              Visits_Per_Area >= .8 & Visits_Per_Area <1.2 ~ "3",
                              Visits_Per_Area >= 1.2 & Visits_Per_Area <1.6 ~ "2",
                              Visits_Per_Area >= 2 ~ "1")) %>%
    mutate(Pop_String  = fct_relevel(Pop_String, "5","4","3","2","1"))

restaurant_animation <-
  ggplot() +
  geom_sf(data = phl_cbg, fill = "#440255", color = "transparent") +   
  geom_sf(data = restaurant.animation.data, aes(fill = Pop_String), color = "transparent") +
    scale_fill_manual(values = palette5) +
    labs(title = "Restaurant Popularity by Hour",
         subtitle = "One Hour Intervals: {current_frame}") +
  theme(panel.background = element_rect(fill = "black"),
         panel.grid.major = element_line(color = "transparent"),
          panel.grid.minor = element_line(colour = "transparent")) +
    transition_manual(Hour)
  

animate(restaurant_animation, duration=20, renderer = gifski_renderer())
```

The following animation shows the same metric for bars. We observe traffic increasing throughout the day starting in the afternoon.

```{r bar animation}
#Bar Analysis
#Filter Bars
dat_bars <- dat_hour %>%
  filter(top_category == "Drinking Places (Alcoholic Beverages)") 

#Merge CBGs with popularity by hour data
dat_bars_filter <-
  dat_bars %>%
  rename(., GEOID10 = poi_cbg) %>%
  group_by(GEOID10, Hour) %>%
  summarize(Avg_Popularity = mean(Visitors),
            Total_Visits = sum(Visitors)) %>%
  left_join(phl_cbg) %>% 
  st_as_sf() %>%
  mutate(Visits_Per_Area = Total_Visits / Shape__Area * 100)

#Animation of bar popularity by hour
bar.animation.data <-
    dat_bars_filter %>%
    st_sf() %>%
    mutate(Pop_String = case_when(Visits_Per_Area == 0 ~ "5",
                              Visits_Per_Area > 0 & Visits_Per_Area <.2 ~ "4",
                              Visits_Per_Area >= .2 & Visits_Per_Area <.4 ~ "3",
                              Visits_Per_Area >= .4 & Visits_Per_Area <.6 ~ "2",
                              Visits_Per_Area >= .6 ~ "1")) %>%
    mutate(Pop_String  = fct_relevel(Pop_String, "5","4","3","2","1"))

bar_animation <-
  ggplot() +
  geom_sf(data = phl_cbg, fill = "#440255", color = "transparent", ) +
  geom_sf(data = bar.animation.data, aes(fill = Pop_String), color = "transparent") +
    scale_fill_manual(values = palette5) +
    labs(title = "Bar Popularity by Hour",
         subtitle = "One Hour Intervals: {current_frame}") +
  theme(panel.background = element_rect(fill = "black"),
         panel.grid.major = element_line(color = "transparent"),
          panel.grid.minor = element_line(colour = "transparent")) +
    transition_manual(Hour)


animate(bar_animation, duration=20, renderer = gifski_renderer())
```

## Nightlife visitors 

### Philadelphia visitor origins

Next we explore where visitors come from. Separated by nightlife establishment type, Figures 3.6a and 3.6b shows the average distance travelled from each census block group. The distance is calculated by measuring the euclidean distance between the centroid of each origin block group and the destination. Then we calculate the weighted mean of the distance travelled to account for destinations that people in a given block group visit more frequently.

For business types that are well-dispersed throughout the city, such as bars and restaurants, it appears that visitors typically travel shorter distances. For business types with fewer destinations, such as casinos, or that are clusters in specific areas of the city, such as hotels, it is common for visitors to make longer trips to these destinations.

Census block groups colored grey have no recorded visitors to the business type

```{r origin data wrangling}
cbg_origin <- #takes a really long time!
  dat_cbg %>%
  filter(top_category == "Drinking Places (Alcoholic Beverages)" |
           top_category == "Restaurants and Other Eating Places" |
           top_category == "Traveler Accommodation" |
           top_category == "Gambling Industries" |
           top_category == "Promoters of Performing Arts, Sports, and Similar Events" |
           top_category == "Performing Arts Companies") %>% #filter for nightlife establishments
  st_drop_geometry() %>% #drop geometry to join with cbg file
  rename(., GEOID10 = Visitor_CBG) %>% #renaming to match cbg file
  left_join(phl_cbg, by = "GEOID10") %>% # join to cbg file
  select(safegraph_place_id, 
         poi_cbg, 
         GEOID10, 
         Visitors, 
         geometry) %>% #clean up dataset
  rename(., cbg_origin = GEOID10, #clean up column names
         cbg_dest = poi_cbg,
         geometry_origin = geometry) %>%
  left_join(phila, by = "safegraph_place_id") %>% #join back to the SafeGraph locations
  select(safegraph_place_id, 
         top_category, 
         sub_category, 
         cbg_dest, 
         cbg_origin, 
         Visitors, 
         geometry_origin, 
         geometry) %>%
  rename(., geometry_dest = geometry) %>%
  drop_na(geometry_origin) %>% #removing geometries that didn't match (ie outside philily)
  mutate(distance = mapply(st_distance, st_centroid(geometry_origin), geometry_dest)) #calculate distance
```

```{r origin viz message=FALSE, warning=FALSE, include=FALSE}
#Continuous
cbg_origin %>%
  group_by(cbg_origin, top_category) %>%
  summarize(avg_distance = mean(distance)) %>%  
  rename(., GEOID10 = cbg_origin) %>%
  left_join(phl_cbg, by = "GEOID10") %>%
  mutate(avg_distance = as.numeric(avg_distance)) %>%
  st_as_sf() %>%
  ggplot() +
  geom_sf(data = phl_cbg, fill = "grey70", color = "transparent") +
  geom_sf(aes(fill = avg_distance), color = "transparent") + 
  scale_fill_viridis() + 
  mapTheme() +
  labs(title = "How far do people travel to nightlife?", 
       subtitle = "Figure 3.6a") +
  facet_wrap(~top_category)

#Quintile
cbg_origin %>%
  drop_na(distance) %>%  
  group_by(cbg_origin, top_category) %>%
  summarize(avg_distance = weighted.mean(distance, Visitors)) %>%  
  rename(., GEOID10 = cbg_origin) %>%
  left_join(phl_cbg, by = "GEOID10") %>%
  mutate(avg_distance = as.numeric(avg_distance)) %>%
  st_as_sf() %>%
  ggplot() +
  geom_sf(data = phl_cbg, fill = "grey70", color = "transparent") +
  geom_sf(aes(fill = q5(avg_distance)), color = "transparent") + 
  scale_fill_manual(values = palette5,
                    aesthetics = c("colour", "fill"),
                    name = "Average Distance \n(Quintile)") +
  mapTheme() +
  labs(title = "How far do people travel to nightlife (quintile)?",
       subtitle = "Figure 3.6b") +
  facet_wrap(~top_category)
```

### Philadelphia destinations

Next, we study how far do Philadelphia visitors travel to nightlife establishemnts. These maps show the average distance travelled to each destination. Similar to the above, distance travelled is calculated by meauring the euclidena distance from each destination to the centroid of each visitor's block group. The metric shown here represented the weighted average of trips and distances.

In general, we see that visitors travel further to Center City destinations. Importantly, these graphics exclude all trips that originate outside of Philadelphia.

```{r destination data wrangling}
cbg_dest <-
  dat_cbg %>%
  filter(top_category == "Drinking Places (Alcoholic Beverages)" |
           top_category == "Restaurants and Other Eating Places" |
           top_category == "Traveler Accommodation" |
           top_category == "Gambling Industries" |
           top_category == "Promoters of Performing Arts, Sports, and Similar Events" |
           top_category == "Performing Arts Companies") %>%
  st_drop_geometry() %>%
  rename(., GEOID10 = Visitor_CBG) %>%
  left_join(phl_cbg, by = "GEOID10") %>%
  select(safegraph_place_id, 
         GEOID10, 
         poi_cbg, 
         Visitors, 
         geometry) %>%
  rename(., cbg_origin = GEOID10,
         geometry_origin = geometry,
         cbg_dest = poi_cbg) %>%
  left_join(phila, by = "safegraph_place_id") %>%
  select(safegraph_place_id, 
         top_category, 
         sub_category, 
         cbg_origin, 
         cbg_dest, 
         Visitors, 
         geometry_origin, 
         geometry) %>%
  rename(., geometry_dest = geometry) %>%
  drop_na(geometry_origin) %>% #dropping origins outside of philadelphia
  mutate(distance = mapply(st_distance, st_centroid(geometry_origin), st_centroid(geometry_dest)))
```

```{r destination viz}
#Continuous
cbg_dest %>%
  group_by(safegraph_place_id, top_category) %>%
  summarize(avg_distance = weighted.mean(distance, Visitors)) %>%
  dplyr::select(safegraph_place_id, avg_distance) %>%
  left_join(phila, by = "safegraph_place_id") %>%
  st_as_sf() %>%
  ggplot() +
  geom_sf(data = phl_cbg, fill = "grey70", color = "transparent") +
  geom_sf(aes(color = avg_distance), size = 1) + 
  scale_fill_viridis(aesthetics = "color") +
  mapTheme() +
  labs(title = "Which nightlife destinations do visitors travel the furthest?",
       subtitle = "Figure 3.7a") +
  facet_wrap(~top_category)

#Quintile
cbg_dest %>%
  group_by(safegraph_place_id, top_category) %>%
  summarize(avg_distance = weighted.mean(distance, Visitors)) %>%
  dplyr::select(safegraph_place_id, avg_distance) %>%
  left_join(phila, by = "safegraph_place_id") %>%
  st_as_sf() %>%
  ggplot() +
  geom_sf(data = phl_cbg, fill = "grey70", color = "transparent") +
  geom_sf(aes(color = q5(avg_distance)), size = 1) + 
  scale_fill_manual(values = palette5,
                    aesthetics = c("colour", "fill"),
                    name = "Average Distance \n(Quintile)") +
  mapTheme() +
  labs(title = "Which nightlife destinations do visitors travel the farthest?",
       subtitle = "Figure 3.7b") +
  facet_wrap(~top_category)
```

## Nightlife corridors in Philadelphia

Where are the exisitng nightlife and commercial corridors in Philadelphia? 

[TBD]

## Neighborhood and corridor comparisons

Finally, we began exploring businesses at the corridor level and understand how different corridors attract different visitors from across the city. We plan to systematically expand the scope of this study to other corridors across the city. We also believe that this data is particularly relevant to business and economic development professionals in the COVID-19 recovery efforts.

Using the Commercial Corridor shapefile available on Open Data Philly, we selected two corridors to compare:  East Girard Avenue, a central corridor in the Fishtown neighborhood, and West Girard Avenue in Brewerytown. 

```{r East Girard data wrangling}
#East Girard Corridor
EastGirard_corr <- 
  phl_corridors %>% 
  filter(NAME == "East Girard") %>% 
  st_as_sf()

dat_EGC <- dat2[EastGirard_corr,]

dat_EGC_cbg <- 
  dat_EGC %>%
  select(safegraph_place_id, 
         date_range_start, 
         top_category, 
         sub_category, 
         visitor_home_cbgs, 
         geometry) %>%
  mutate(visitor_home_cbgs = str_remove_all(visitor_home_cbgs, pattern = "\\[|\\]")) %>%
  mutate(visitor_home_cbgs = str_remove_all(visitor_home_cbgs, pattern = "\\{|\\}")) %>%
  mutate(visitor_home_cbgs = str_remove_all(visitor_home_cbgs, pattern = '\\"|\\"')) %>%
  mutate(visitor_home_cbgs = str_split(visitor_home_cbgs, pattern = ",")) %>%
  unnest(visitor_home_cbgs) %>%
  separate(.,
           visitor_home_cbgs,
           c("cbg_origin", "visitors"),
           sep = ":") %>%
  mutate(cbg_origin = as.numeric(cbg_origin),
         visitors = as.numeric(visitors)) %>%
  filter(top_category == "Drinking Places (Alcoholic Beverages)" |
           top_category == "Restaurants and Other Eating Places" |
           top_category == "Traveler Accommodation" |
           top_category == "Gambling Industries" |
           top_category == "Promoters of Performing Arts, Sports, and Similar Events" |
           top_category == "Performing Arts Companies") %>%
    mutate(corridor = "East Girard")

#West Girard
WestGirard_corr <- 
  phl_corridors %>% 
  filter(NAME == "West Girard") %>% 
  st_as_sf()

dat_WGC <- dat2[WestGirard_corr,]

dat_WGC_cbg <- 
  dat_WGC %>%
  select(safegraph_place_id, 
         date_range_start, 
         top_category, 
         sub_category, 
         visitor_home_cbgs, 
         geometry) %>%
  mutate(visitor_home_cbgs = str_remove_all(visitor_home_cbgs, pattern = "\\[|\\]")) %>%
  mutate(visitor_home_cbgs = str_remove_all(visitor_home_cbgs, pattern = "\\{|\\}")) %>%
  mutate(visitor_home_cbgs = str_remove_all(visitor_home_cbgs, pattern = '\\"|\\"')) %>%
  mutate(visitor_home_cbgs = str_split(visitor_home_cbgs, pattern = ",")) %>%
  unnest(visitor_home_cbgs) %>%
  separate(.,
           visitor_home_cbgs,
           c("cbg_origin", "visitors"),
           sep = ":") %>%
  mutate(cbg_origin = as.numeric(cbg_origin),
         visitors = as.numeric(visitors)) %>%
  filter(top_category == "Drinking Places (Alcoholic Beverages)" |
           top_category == "Restaurants and Other Eating Places" |
           top_category == "Traveler Accommodation" |
           top_category == "Gambling Industries" |
           top_category == "Promoters of Performing Arts, Sports, and Similar Events" |
           top_category == "Performing Arts Companies") %>%
  mutate(corridor = "West Girard")
```

Figures 3.8a and 3.8b show the volume of visitors to the East Girard Corridor (outlined in red) by census block group. While visitors from across the city frequent East Girard corridor, particularly for its restaurants, Figure 3.8b clarifies that the corridor mostly caters to a local customer base of surrounding census tracts.

Block groups shaded gray indicate that no resident made a trip to this corridor.
```{r}
dat_EGC_cbg %>%
  group_by(cbg_origin, top_category) %>%
  summarize(visitors = sum(visitors)) %>%
  st_drop_geometry() %>%
  rename(., GEOID10 = cbg_origin) %>%
  left_join(phl_cbg, by = "GEOID10") %>%
  st_as_sf() %>%
  drop_na(geometry) %>% 
  ggplot() +
  geom_sf(data = phl_cbg, fill = "grey70", color = "transparent") +
  geom_sf(aes(fill = q5(visitors), geometry = geometry), color = "transparent") + 
  geom_sf(data = phl_nhoods, color = "white", fill = "transparent") +
  geom_sf(data = EastGirard_corr, color = "red", fill = "transparent", lwd = 1) +
  scale_fill_manual(values = palette5,
                    aesthetics = c("colour", "fill"),
                    name = "Visitor Count \n(Quintile)") +
  mapTheme() +
  labs(title = "East Girard Restaurants: Where do visitors come from?",
       subtitle = "Figure 3.8a") +
  facet_wrap(~top_category)

dat_EGC_cbg %>%
  group_by(cbg_origin, top_category) %>%
  summarize(visitors = sum(visitors)) %>%
  st_drop_geometry() %>%
  rename(., GEOID10 = cbg_origin) %>%
  left_join(phl_cbg, by = "GEOID10") %>%
  st_as_sf() %>%
  drop_na(geometry) %>% 
  ggplot() +
  geom_sf(data = phl_cbg, fill = "grey70", color = "transparent") +
  geom_sf(aes(fill = visitors, geometry = geometry), color = "transparent") + 
  geom_sf(data = phl_nhoods, color = "white", fill = "transparent") +
  geom_sf(data = EastGirard_corr, color = "red", fill = "transparent", lwd = .5) +
  scale_fill_viridis() +
  mapTheme() +
  labs(title = "East Girard Restaurants: Where do visitors come from?",
       subtitle = "Figure 3.8b") +
  facet_wrap(~top_category)
```

Figures 3.9a and 3.9b show the volume of visitors to West Girard corridor. While the corridor appears to draw visitors from fewer census tracts overall, the corridor draws from a similarly local customer base of the surrounding block groups.

As before, block groups shaded gray have no residents that made trips to this corridor.
```{r West Girard viz}
dat_corridors %>%
  ggplot() +
  geom_sf(data = phl_cbg, fill = "grey80", color = "transparent") +
  geom_sf(data = phl_corridors, aes(fill = P_DIST))

dat_WGC_cbg %>%
  group_by(cbg_origin, top_category) %>%
  summarize(visitors = sum(visitors)) %>%
  st_drop_geometry() %>%
  rename(., GEOID10 = cbg_origin) %>%
  left_join(phl_cbg, by = "GEOID10") %>%
  st_as_sf() %>%
  drop_na(geometry) %>% 
  ggplot() +
  geom_sf(data = phl_cbg, fill = "grey70", color = "transparent") +
  geom_sf(aes(fill = q5(visitors), geometry = geometry), color = "transparent") + 
  geom_sf(data = phl_nhoods, color = "white", fill = "transparent") +
  geom_sf(data = WestGirard_corr, color = "red", fill = "transparent", lwd = 1) +
  scale_fill_manual(values = palette5,
                    aesthetics = c("colour", "fill"),
                    name = "Visitor Count \n(Quintile)") +
  mapTheme() +
  labs(title = "West Girard: Where do visitors come from?",
       subtitle = "Figure 3.9a") +
  facet_wrap(~top_category)

dat_WGC_cbg %>%
  group_by(cbg_origin, top_category) %>%
  summarize(visitors = sum(visitors)) %>%
  st_drop_geometry() %>%
  rename(., GEOID10 = cbg_origin) %>%
  left_join(phl_cbg, by = "GEOID10") %>%
  st_as_sf() %>%
  drop_na(geometry) %>% 
  ggplot() +
  geom_sf(data = phl_cbg, fill = "grey70", color = "transparent") +
  geom_sf(aes(fill = visitors, geometry = geometry), color = "transparent") + 
  geom_sf(data = phl_nhoods, color = "white", fill = "transparent") +
  geom_sf(data = WestGirard_corr, color = "red", fill = "transparent", lwd = .5) +
  scale_fill_viridis() +
  mapTheme() +
  labs(title = "East Girard Restaurants: Where do visitors come from?",
       subtitle = "Figure 3.9b") +
  facet_wrap(~top_category)
```

We can deepen our analysis by tying the trip origins to census data. This allows us to construct a customer profile of the visitors visiting specific corridors throughout the city.
```{r census pull}
phl_blockgroups <- 
  get_acs(geography = "block group", 
        variables = c("B01003_001E", 
                      "B02001_002E", 
                      "B01002_001E",
                      "B19013_001E", 
                      "B25064_001E"),
        year=2018, 
        state=42, 
        county=101, 
        geometry=T, 
        output = "wide") %>%
  st_transform('ESRI:102728')%>%
  rename(TotalPop = B01003_001E,
         Whites = B02001_002E,
         MedAge = B01002_001E,
         MedHHInc = B19013_001E,
         MedRent = B25064_001E,
         GEOID10 = GEOID) %>%
  dplyr::select(-NAME, -starts_with("B")) %>%
  mutate(pctWhite = ifelse(TotalPop > 0, Whites / TotalPop,0),
         GEOID10 = as.numeric(GEOID10)) %>%
  dplyr::select(-Whites) 
```

The below Figure 3.XX compares demographic indicators pulled from the census across the two customer bases. East Girard corridor's customer base, shown in purple, tend to come from whiter census tracts with a higher median household income and median rent. West Girard corridor's customer base tend to come from less white census tracts with lower incomes and median rent. Both corridors, however, pull from census tracts with a similar median age.
```{r corridor comparison}
rbind(dat_EGC_cbg, dat_WGC_cbg) %>%
  rename(GEOID10 = cbg_origin) %>%
  dplyr::select(GEOID10, visitors, corridor) %>%
  st_drop_geometry() %>%
  left_join(phl_blockgroups, by = "GEOID10") %>%
  pivot_longer(.,
               cols = c("MedAge", "MedHHInc", "MedRent", "pctWhite"),
               names_to = "variable") %>%
  dplyr::select(GEOID10, corridor, visitors, variable, value) %>%
  ggplot(., aes(x = value, fill = corridor, weight = visitors)) + 
  geom_density(alpha = .5) +
  scale_fill_manual(values = palette3,
                    aesthetics = c("colour", "fill"),
                    name = "Visitor Count \n(Quintile)") +
  facet_wrap( ~ variable, scales = "free") +
  plotTheme() +
  labs(title = 'East Girard vs. West Girard Corridors',
       subtitle = "Figure 3.XX")
```

# 4. Next Steps

We will continue our Exploratory Data Analysis and plan to focus on the following topics:

* Defining and demarcating distinct Philadelphia nightlife corridors.
* Expanding analysis to the regional scale.  Currently we only review trips originating within Phialdelphia, but it will be important to understand which districts have a more regional approach.
* Understand how COVID-19 has impacted nightlife foot traffic in Philadelphia? Have corridors been impacted evenly?